<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="../style.css">

    </head>

    <body>

        <div class="divPrincipal">
            <p class="textoTitulo">Perfil</p>

            <div class="duplaBotoes">
                <button class="botaoSubmit" id="salvar" style="margin-top: 5px;">Salvar informações principais</button>
                <a class="botaoSubmit" id="excluir" style="margin-top: 5px;" href="index.html">Cancelar</a>
            </div>
            <p class="textoDestaque">Informações principais</p>
            <p class="textoDestaque">Nome completo</p>
            <input type="text" class="campoInput" id="nome" placeholder="nome">

            <p class="textoDestaque">Email cadastrado</p>
            <input type="email" class="campoInput" id="email" placeholder="email">

            <p class="textoDestaque">Senha</p>
            <input type="text" class="campoInput" id="senha" placeholder="senha">

            <p class="textoDestaque">Biografia</p>
            <input type="text" class="campoInput" id="biografia" placeholder="biografia">

            <p class="textoDestaque">Especialidade</p>
            <input type="text" class="campoInput" id="especialidade" placeholder="especialidade">

            <p class="textoDestaque">Locais</p>
            <button class="botaoSubmit" id="adicionarLocal" style="margin-bottom: 10px;">Adicionar Local</button>
            <div id="locais">
                <p>carregando...</p>
            </div>
            <hr>

            <div class="textoDestaque" style="margin-top:20px;">Disponibilidades</div>
            <button class="botaoSubmit" id="adicionarDisponibilidade" style="margin-top: 10px; margin-bottom: 10px;">Adicionar Disponibilidade</button>
            <div id="disponibilidades">
                <p>carregando...</p>
            </div>
            <hr>

            <div class="textoDestaque" style="margin-top:20px;">Disponibilidades Bloqueadas</div>
            <button class="botaoSubmit" id="adicionarBloqueio" style="margin-top: 10px; margin-bottom: 10px;">Adicionar Bloqueio</button>
            <div id="bloqueios">
                <p>carregando...</p>
            </div>
            <hr>

        </div>

    <script>

        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return str.toString()
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
        }

        function carregarLocais() {
            fetch("../phpAPIs/CRUD local/getLocal.php")
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    const divLocais = document.getElementById("locais");
                    divLocais.innerHTML = "";

                    if (!data.sucesso || data.dados.length === 0) {
                        divLocais.innerHTML = "<p>Nenhum local cadastrado.</p>";
                        return;
                    }

                    let html = "<ul>";
                    data.dados.forEach(local => {
                        html += `
                            <li data-id="${local.id_local}">
                                <div class="divAgendamento">
                                    <div>
                                        <p class="textoDestaque">Tipo: ${local.tipo_local}</p>
                                        <p class="textoComum">Endereço: ${escapeHTML(local.endereco || '—')}</p>
                                        <p class="textoComum">CEP: ${escapeHTML(local.CEP || '—')}</p>
                                        <p class="textoComum">Obs: ${escapeHTML(local.observacoes || '—')}</p>
                                    </div>
                                    <div class="duplaBotoesPaginasInternas">
                                        <button class="botaoSubmit" onclick="editarLocal(${local.id_local}, this)">Editar</button>
                                        <button class="botaoSubmit" onclick="deletarLocal(${local.id_local})">Excluir</button>
                                    </div>
                                </div>
                            </li>
                        `;
                    });
                    html += "</ul>";
                    divLocais.innerHTML = html;
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById("locais").innerHTML = "<p>Erro ao carregar locais.</p>";
                });
        }

        document.getElementById("adicionarLocal").addEventListener("click", () => {
            const divLocais = document.getElementById("locais");

            //sem mais de um forms ao mesmo tempo
            if (document.getElementById("novoLocalForm")) return;

            const formHTML = `
                <div class="divAgendamento" id="novoLocalForm">
                    <select id="novo_tipo_local" class="campoInput">
                        <option value="" disabled selected>Selecione o tipo</option>
                        <option value="presencial">Presencial</option>
                        <option value="domicilio">Domicílio</option>
                        <option value="online">Online</option>
                    </select>
                    <input type="text" id="novo_endereco" class="campoInput" placeholder="Endereço">
                    <input type="text" id="novo_CEP" class="campoInput" placeholder="CEP">
                    <input type="text" id="novo_observacoes" class="campoInput" placeholder="Observações">

                    <button class="botaoSubmit" onclick="salvarNovoLocal()">Salvar</button>
                    <button class="botaoSubmit" onclick="cancelarNovoLocal()">Cancelar</button>
                </div>
            `;

            divLocais.insertAdjacentHTML("afterbegin", formHTML);
        });

        function cancelarNovoLocal() {
            const form = document.getElementById("novoLocalForm");
            if (form) form.remove();
        }

        function salvarNovoLocal() {
            const tipo_local = document.getElementById("novo_tipo_local").value.trim();
            const endereco = document.getElementById("novo_endereco").value.trim();
            const CEP = document.getElementById("novo_CEP").value.trim();
            const observacoes = document.getElementById("novo_observacoes").value.trim();

            if (!tipo_local) return alert("O tipo de local é obrigatório.");

            fetch("../phpAPIs/CRUD%20local/postLocal.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ tipo_local, endereco, CEP, observacoes })
            })
            .then(r => r.json())
            .then(data => {
                if (data.sucesso) {
                    alert("Local adicionado com sucesso!");
                    carregarLocais();
                } else {
                    alert("Erro: " + data.mensagem);
                }
            })
            .catch(err => {
                console.error(err);
                alert("Erro ao adicionar local.");
            });
        }


        function editarLocal(id_local, botao) {
            const li = botao.closest("li");
            const campos = li.querySelectorAll("p");
            const dados = {};

            campos.forEach(p => {
                const texto = p.textContent.split(":");
                let chave = texto[0].trim().toLowerCase();
                const valor = texto[1]?.trim() || "";
                if (chave == "endereço"){
                    const chave1 = "endereco";
                }
                const chave1 = chave;
                dados[chave1] = valor;
            });

            li.innerHTML = `
                <div class="divAgendamento">
                    <select id="tipo_local_${id_local}" class="campoInput">
                        <option value="presencial" ${dados.tipo === "presencial" ? "selected" : ""}>Presencial</option>
                        <option value="domicilio" ${dados.tipo === "domicilio" ? "selected" : ""}>Domicílio</option>
                        <option value="online" ${dados.tipo === "online" ? "selected" : ""}>Online</option>
                    </select>
                    <input type="text" id="endereco_${id_local}" class="campoInput" value="${dados.endereco || ''}" placeholder="Endereço">
                    <input type="text" id="cep_${id_local}" class="campoInput" value="${dados.cep || ''}" placeholder="CEP">
                    <input type="text" id="observacoes_${id_local}" class="campoInput" value="${dados.obs || ''}" placeholder="Observações">
                    <button class="botaoSubmit" onclick="salvarEdicao(${id_local})">Salvar</button>
                    <button class="botaoSubmit" onclick="carregarLocais()">Cancelar</button>
                </div>
            `;
        }

        function salvarEdicao(id_local) {
            const tipo_local = document.getElementById(`tipo_local_${id_local}`).value.trim();
            const endereco = document.getElementById(`endereco_${id_local}`).value.trim();
            const CEP = document.getElementById(`cep_${id_local}`).value.trim();
            const observacoes = document.getElementById(`observacoes_${id_local}`).value.trim();

            if (!tipo_local) return alert("O tipo de local é obrigatório.");

            fetch("../phpAPIs/CRUD local/putLocal.php", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id_local, tipo_local, endereco, CEP, observacoes })
            })
            .then(r => r.json())
            .then(data => {
                if (data.sucesso) {
                    alert("Local atualizado com sucesso!");
                    carregarLocais();
                } else {
                    alert("Erro: " + data.mensagem);
                }
            })
            .catch(err => {
                console.error(err);
                alert("Erro ao atualizar local.");
            });
        }


        function deletarLocal(id_local) {
            if (!confirm("Tem certeza que deseja excluir este local?")) return;

            fetch("../phpAPIs/CRUD local/deleteLocal.php", {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id_local })
            })
            .then(r => r.json())
            .then(data => {
                if (data.sucesso) {
                    alert("Local excluído com sucesso!");
                    carregarLocais();
                } else {
                    alert("Erro: " + data.mensagem);
                }
            })
            .catch(err => {
                console.error(err);
                alert("Erro ao excluir local.");
            });
        }

        // carrega perfil e locais, disp e bloqueios
        document.addEventListener("DOMContentLoaded", () => {
            fetch("../phpAPIs/CRUD profissional/getProfissional.php")
                .then(response => response.json())
                .then(data => {
                    if (data.sucesso) {
                        const dados = data.dados[0].profissional;
                        document.getElementById("nome").value = dados.nome;
                        document.getElementById("email").value = dados.email;
                        document.getElementById("senha").value = dados.senha;
                        document.getElementById("especialidade").value = dados.especialidade;
                        document.getElementById("biografia").value = dados.biografia;
                    } else {
                        document.body.innerHTML = `<p>Erro: ${data.erro || "Usuário não encontrado."}</p>`;
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.body.innerHTML = "<p>Erro ao carregar os dados do usuário.</p>";
                });

            document.getElementById("salvar").addEventListener("click", () => {
                const nome = document.getElementById("nome").value.trim();
                const email = document.getElementById("email").value.trim();
                const senha = document.getElementById("senha").value.trim();
                const biografia = document.getElementById("biografia").value.trim();
                const especialidade = document.getElementById("especialidade").value.trim();

                const emailValido = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

                if (!emailValido) {
                    alert("Por favor, insira um e-mail válido.");
                    return;
                }

                if (!nome || !email || !senha) {
                    alert("Preencha nome, email e senha.");
                    return;
                }

                fetch("../phpAPIs/CRUD profissional/putProfissional.php", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ nome, email, senha, especialidade, biografia })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.sucesso) {
                        alert("Dados atualizados com sucesso!");
                        window.location.href = "index.html";
                    } else {
                        alert("Erro: " + data.mensagem);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Erro ao atualizar usuário.");
                });
            });

            carregarLocais();
            carregarDisponibilidades();
            carregarBloqueios();
        });

        function carregarDisponibilidades() {
            fetch("../phpAPIs/CRUD disponibilidade/getDisponibilidade.php")
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById("disponibilidades");
                    container.innerHTML = "";
                    if (!data.sucesso || !data.dados || data.dados.length === 0) {
                        container.innerHTML = "<p>Nenhuma disponibilidade cadastrada.</p>";
                        return;
                    }
                    let html = "<ul>";
                    data.dados.forEach(d => {
                        html += `
                            <li data-id="${d.id_disponibilidade}">
                                <div class="divAgendamento">
                                    <div>
                                        <p class="textoDestaque">Dia: ${escapeHTML(d.dia_semana)}</p>
                                        <p class="textoComum">Inicio: ${escapeHTML(d.hora_inicio)}</p>
                                        <p class="textoComum">Fim: ${escapeHTML(d.hora_fim)}</p>
                                    </div>
                                    <div class="duplaBotoesPaginasInternas">
                                        <button class="botaoSubmit" onclick="editarDisponibilidade(${d.id_disponibilidade}, this)">Editar</button>
                                        <button class="botaoSubmit" onclick="deletarDisponibilidade(${d.id_disponibilidade})">Excluir</button>
                                    </div>
                                </div>
                            </li>
                        `;
                    });
                    html += "</ul>";
                    container.innerHTML = html;
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById("disponibilidades").innerHTML = "<p>Erro ao carregar disponibilidades.</p>";
                });
        }

        document.getElementById("adicionarDisponibilidade").addEventListener("click", () => {
            if (document.getElementById("novoDisponibilidadeForm")) return;

            const formHTML = `
                <div class="divAgendamento" id="novoDisponibilidadeForm">
                    <select id="novo_dia_semana" class="campoInput">
                        <option value="" disabled selected>Selecione o dia</option>
                        <option value="Domingo">Domingo</option>
                        <option value="Segunda">Segunda</option>
                        <option value="Terca">Terca</option>
                        <option value="Quarta">Quarta</option>
                        <option value="Quinta">Quinta</option>
                        <option value="Sexta">Sexta</option>
                        <option value="Sabado">Sabado</option>
                    </select>
                    <input type="time" id="novo_hora_inicio" class="campoInput" placeholder="Hora início">
                    <input type="time" id="novo_hora_fim" class="campoInput" placeholder="Hora fim">
                    <button class="botaoSubmit" onclick="salvarNovoDisponibilidade()">Salvar</button>
                    <button class="botaoSubmit" onclick="cancelarNovoDisponibilidade()">Cancelar</button>
                </div>
            `;
            document.getElementById("disponibilidades").insertAdjacentHTML("afterbegin", formHTML);
        });

        function cancelarNovoDisponibilidade() {
            const f = document.getElementById("novoDisponibilidadeForm");
            if (f) f.remove();
        }

        function salvarNovoDisponibilidade() {
            const dia_semana = document.getElementById("novo_dia_semana").value || "";
            const hora_inicio = document.getElementById("novo_hora_inicio").value || "";
            const hora_fim = document.getElementById("novo_hora_fim").value || "";

            if (!dia_semana || !hora_inicio || !hora_fim) return alert("Preencha dia e horários.");

            fetch("../phpAPIs/CRUD disponibilidade/postDisponibilidade.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ dia_semana, hora_inicio, hora_fim })
            })
            .then(r => r.json())
            .then(res => {
                if (res.sucesso) {
                    alert("Disponibilidade adicionada!");
                    carregarDisponibilidades();
                } else alert("Erro: " + (res.mensagem || "Não foi possível adicionar."));
            })
            .catch(err => {
                console.error(err);
                alert("Erro ao adicionar disponibilidade.");
            });
        }

        function editarDisponibilidade(id_disponibilidade, botao) {
            const li = botao.closest("li");
            const campos = li.querySelectorAll("p");
            const dados = {};

            campos.forEach(p => {
                const texto = p.textContent.split(": ");
                let chave = texto[0].trim().toLowerCase();
                const valor = texto[1]?.trim() || "";
                dados[chave] = valor;
            });

            console.log(dados);

            li.innerHTML = `
                <div class="divAgendamento">
                    <select id="dia_${id_disponibilidade}" class="campoInput">
                        <option value="Domingo" ${dados.dia==="Domingo"?"selected":""}>Domingo</option>
                        <option value="Segunda" ${dados.dia==="Segunda"?"selected":""}>Segunda</option>
                        <option value="Terca" ${dados.dia==="Terca"?"selected":""}>Terca</option>
                        <option value="Quarta" ${dados.dia==="Quarta"?"selected":""}>Quarta</option>
                        <option value="Quinta" ${dados.dia==="Quinta"?"selected":""}>Quinta</option>
                        <option value="Sexta" ${dados.dia==="Sexta"?"selected":""}>Sexta</option>
                        <option value="Sabado" ${dados.dia==="Sabado"?"selected":""}>Sabado</option>
                    </select>
                    <input type="time" id="inicio_${id_disponibilidade}" class="campoInput" value="${dados.inicio || ''}">
                    <input type="time" id="fim_${id_disponibilidade}" class="campoInput" value="${dados.fim || ''}">
                    <button class="botaoSubmit" onclick="salvarEdicaoDisponibilidade(${id_disponibilidade})">Salvar</button>
                    <button class="botaoSubmit" onclick="carregarDisponibilidades()">Cancelar</button>
                </div>
            `;
        }

        function salvarEdicaoDisponibilidade(id_disponibilidade) {
            const dia_semana = document.getElementById(`dia_${id_disponibilidade}`).value || "";
            const hora_inicio = document.getElementById(`inicio_${id_disponibilidade}`).value || "";
            const hora_fim = document.getElementById(`fim_${id_disponibilidade}`).value || "";

            if (!dia_semana || !hora_inicio || !hora_fim) return alert("Preencha dia e horários.");

            fetch("../phpAPIs/CRUD disponibilidade/putDisponibilidade.php", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id_disponibilidade, dia_semana, hora_inicio, hora_fim })
            })
            .then(r => r.json())
            .then(res => {
                if (res.sucesso) {
                    alert("Disponibilidade atualizada!");
                    carregarDisponibilidades();
                } else alert("Erro: " + (res.mensagem || "Não foi possível atualizar."));
            })
            .catch(err => {
                console.error(err);
                alert("Erro ao atualizar disponibilidade.");
            });
        }

        function deletarDisponibilidade(id_disponibilidade) {
            if (!confirm("Tem certeza que deseja excluir esta disponibilidade?")) return;
            fetch("../phpAPIs/CRUD disponibilidade/deleteDisponibilidade.php", {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id_disponibilidade })
            })
            .then(r => r.json())
            .then(res => {
                if (res.sucesso) {
                    alert("Disponibilidade excluída!");
                    carregarDisponibilidades();
                } else alert("Erro: " + (res.mensagem || "Não foi possível excluir."));
            })
            .catch(err => {
                console.error(err);
                alert("Erro ao excluir disponibilidade.");
            });
        }

        function carregarBloqueios() {
            fetch("../phpAPIs/CRUD disponibilidade_bloqueada/getBloqueio.php")
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById("bloqueios");
                    container.innerHTML = "";
                    if (!data.sucesso || !data.dados || data.dados.length === 0) {
                        container.innerHTML = "<p>Nenhum bloqueio cadastrado.</p>";
                        return;
                    }
                    let html = "<ul>";
                    data.dados.forEach(b => {
                        html += `
                            <li data-id="${b.id_bloqueio}">
                                <div class="divAgendamento">
                                    <div>
                                        <p class="textoDestaque">Início: ${escapeHTML(b.data_inicio)}</p>
                                        <p class="textoComum">Fim: ${escapeHTML(b.data_fim)}</p>
                                    </div>
                                    <div class="duplaBotoesPaginasInternas">
                                        <button class="botaoSubmit" onclick="editarBloqueio(${b.id_bloqueio}, this)">Editar</button>
                                        <button class="botaoSubmit" onclick="deletarBloqueio(${b.id_bloqueio})">Excluir</button>
                                    </div>
                                </div>
                            </li>
                        `;
                    });
                    html += "</ul>";
                    container.innerHTML = html;
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById("bloqueios").innerHTML = "<p>Erro ao carregar bloqueios.</p>";
                });
        }

        document.getElementById("adicionarBloqueio").addEventListener("click", () => {
            if (document.getElementById("novoBloqueioForm")) return;

            const formHTML = `
                <div class="divAgendamento" id="novoBloqueioForm">
                    <label class="textoComum">Início</label>
                    <input type="datetime-local" id="novo_data_inicio" class="campoInput">
                    <label class="textoComum">Fim</label>
                    <input type="datetime-local" id="novo_data_fim" class="campoInput">
                    <button class="botaoSubmit" onclick="salvarNovoBloqueio()">Salvar</button>
                    <button class="botaoSubmit" onclick="cancelarNovoBloqueio()">Cancelar</button>
                </div>
            `;
            document.getElementById("bloqueios").insertAdjacentHTML("afterbegin", formHTML);
        });

        function cancelarNovoBloqueio() {
            const f = document.getElementById("novoBloqueioForm");
            if (f) f.remove();
        }

        function salvarNovoBloqueio() {
            const data_inicio = document.getElementById("novo_data_inicio").value || "";
            const data_fim = document.getElementById("novo_data_fim").value || "";

            if (!data_inicio || !data_fim) return alert("Preencha data/hora de início e fim.");

            const d1 = data_inicio.replace("T", " ") + ":00";
            const d2 = data_fim.replace("T", " ") + ":00";

            fetch("../phpAPIs/CRUD disponibilidade_bloqueada/postBloqueio.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ data_inicio: d1, data_fim: d2 })
            })
            .then(r => r.json())
            .then(res => {
                if (res.sucesso) {
                    alert("Bloqueio adicionado!");
                    carregarBloqueios();
                } else alert("Erro: " + (res.mensagem || "Não foi possível adicionar."));
            })
            .catch(err => {
                console.error(err);
                alert("Erro ao adicionar bloqueio.");
            });
        }

        function editarBloqueio(id_bloqueio, botao) {

            const li = botao.closest("li");
            const campos = li.querySelectorAll("p");
            const dados = {};

            campos.forEach(p => {
                const texto = p.textContent.split(": ");
                let chave = texto[0].trim().toLowerCase();
                const valor = texto[1]?.trim() || "";
                dados[chave] = valor;
            });

            console.log(dados);

            li.innerHTML = `
                <div class="divAgendamento">
                    <input type="datetime-local" id="inicio_b_${id_bloqueio}" class="campoInput" value="${dados.início}">
                    <input type="datetime-local" id="fim_b_${id_bloqueio}" class="campoInput" value="${dados.fim}">
                    <button class="botaoSubmit" onclick="salvarEdicaoBloqueio(${id_bloqueio})">Salvar</button>
                    <button class="botaoSubmit" onclick="carregarBloqueios()">Cancelar</button>
                </div>
            `;
        }

        function salvarEdicaoBloqueio(id_bloqueio) {
            const data_inicio_raw = document.getElementById(`inicio_b_${id_bloqueio}`).value || "";
            const data_fim_raw = document.getElementById(`fim_b_${id_bloqueio}`).value || "";

            if (!data_inicio_raw || !data_fim_raw) return alert("Preencha início e fim.");

            const data_inicio = data_inicio_raw.replace("T", " ") + ":00";
            const data_fim = data_fim_raw.replace("T", " ") + ":00";

            fetch("../phpAPIs/CRUD disponibilidade_bloqueada/putBloqueio.php", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id_bloqueio, data_inicio, data_fim })
            })
            .then(r => r.json())
            .then(res => {
                if (res.sucesso) {
                    alert("Bloqueio atualizado!");
                    carregarBloqueios();
                } else alert("Erro: " + (res.mensagem || "Não foi possível atualizar."));
            })
            .catch(err => {
                console.error(err);
                alert("Erro ao atualizar bloqueio.");
            });
        }

        function deletarBloqueio(id_bloqueio) {
            if (!confirm("Tem certeza que deseja excluir este bloqueio?")) return;
            fetch("../phpAPIs/CRUD disponibilidade_bloqueada/deleteBloqueio.php", {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id_bloqueio })
            })
            .then(r => r.json())
            .then(res => {
                if (res.sucesso) {
                    alert("Bloqueio excluído!");
                    carregarBloqueios();
                } else alert("Erro: " + (res.mensagem || "Não foi possível excluir."));
            })
            .catch(err => {
                console.error(err);
                alert("Erro ao excluir bloqueio.");
            });
        }



        </script>
    </body>
</html>




