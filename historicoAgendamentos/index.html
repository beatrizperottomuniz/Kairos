<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="../style.css">
    </head>

    <body>
        <header class="headerInterno">
            <a href="../exportarAgendamentos/index.html" class="linkPag">Exportar</a>
            <a href="../historicoAgendamentos/index.html" class="linkPag">Histórico</a>
            <a href="" id = "agenda" class="linkPag">Agenda</a>
            <a href="../NovoAgendamento/index.html" class="linkPag" id="novoAgendamento" style="display:none;">Novo Agendamento</a>
            <a href="" id = "perfil" class="linkPag">Perfil</a>
        </header>

        <div class="divPrincipal">
            <p class="textoTitulo">Histórico</p>            
            <div id="resultado">
                <p>carregando...</p>
            </div>

        </div>

        <script>
            //para ficar mais facil escape de html
            function escapeHTML(str) {
                if (str === null || str === undefined) return '';
                return str.toString()
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
            }

            function pegarAgendamentos(tipoConta) {

                let url = "../phpAPIs/usuarioAgendamentosPassados.php";

                fetch(url)
                .then(response => response.json())
                .then(data => {
                    const resultadoDiv = document.querySelector("#resultado");
                    resultadoDiv.innerHTML = ''; 

                    if (data.sucesso && data.agendamentos.length > 0) {
                        const hoje = new Date();
                        const hojeData = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                        const agendamentosFiltrados = data.agendamentos.filter(ag => {
                            const dataInicio = new Date(ag.data_hora_inicio);
                            const agendamentoData = new Date(dataInicio.getFullYear(), dataInicio.getMonth(), dataInicio.getDate());
                            return (agendamentoData < hojeData) || (ag.status == "Concluido");
                        });

                        let html = '<ul>';
                        agendamentosFiltrados.forEach(ag => {
                            const dataFormatada_inicio = new Date(ag.data_hora_inicio).toLocaleDateString('pt-BR', {
                            day: '2-digit', month: '2-digit', year: 'numeric'
                            });
                            
                            //se for do tipo cliente, estiver concluido e ainda tiver um profissional pra ser avaliado, temos a secao de avaliacao
                            let secaoAvaliacao = "";
                            if (ag.status === "Concluido" && tipoConta === "cliente" && ag.nome_profissional != "Profissional deletado") {
                                secaoAvaliacao = `
                                <div class="duplaBotoes" id="avaliacao_${ag.id_agendamento}">
                                    <label class="textoDestaque" for="nota_${ag.id_agendamento}">Escolha uma opção:</label>
                                    <select class="campoInput" id="nota_${ag.id_agendamento}" style="width: 200px; height: 30px;">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                    <button class="botaoSubmit" id="botaoAv_${ag.id_agendamento}" onclick="enviarAvaliacao(${ag.id_agendamento})">Enviar Avaliação</button>
                                </div>
                                `;
                            }

                            const horaFormatada_inicio = new Date(ag.data_hora_inicio).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            const horaFormatada_fim = new Date(ag.data_hora_fim).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                            html += `<li>
                                <div class="divAgendamento">
                                    <div>
                                        <p class="textoDestaque">${dataFormatada_inicio}</p> 
                                        <p class="textoComum">${horaFormatada_inicio} até ${horaFormatada_fim}</p>
                                        <p class="textoDestaque">${escapeHTML(ag.nome_servico)}</p> 
                                        <p class="textoComum">Profissional : ${escapeHTML(ag.nome_profissional)}</p>
                                        <p class="textoComum">Cliente : ${escapeHTML(ag.nome_cliente)}</p>
                                        <p class="textoComum">Duração : ${ag.duracao_minutos} minutos</p>
                                        <p class="textoComum" id="Agendamento_${ag.id_agendamento}">Situação : ${ag.status}</p>
                                        ${secaoAvaliacao}
                                    </div>
                                </div>
                            </li>`;
                        });
                        html += '</ul>';
                        resultadoDiv.innerHTML = html;
                        //cahama a funcao de atualizar os botoes de avaliacao (se ja foi avaliado ou nao)
                        atualizarBotoesAvaliacao();

                    }else {
                        resultadoDiv.style.color = 'red';
                        resultadoDiv.textContent = "erro: ${data.mensagem}";
                    }
                })
                .catch(err => {
                    console.error("Erro no fetch:", err);
                    const resultadoDiv = document.querySelector("#resultado");
                    resultadoDiv.style.color = 'red';
                    resultadoDiv.textContent = "erro ao carregar os dados";
                });     
            }

            function enviarAvaliacao(id_agendamento) {
                const select = document.getElementById(`nota_${id_agendamento}`);
                const nota = select.value;

                fetch("../phpAPIs/CR avaliacao/postAvaliacao.php", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({id_agendamento, nota})
                })
                .then(r => r.json())
                .then(data => {
                    if (data.sucesso) {
                        const btn = document.querySelector(`#avaliacao_${id_agendamento} button`);
                        btn.disabled = true;
                        btn.style.backgroundColor = "#A0A0A0";
                        btn.textContent = "Avaliado";
                        alert("Avaliação enviada com sucesso!");
                    } else {
                        alert(data.mensagem);
                    }
                })
                .catch(err => console.error("Erro ao enviar avaliação:", err));
            }

            function atualizarBotoesAvaliacao(){
                //seleciona bts de av
                const botoesAvaliacao = document.querySelectorAll("button[id^='botaoAv_']");

                botoesAvaliacao.forEach(btn => {
                    const id_agendamento = btn.id.replace("botaoAv_", "");
                    const select = document.getElementById(`nota_${id_agendamento}`);

                    fetch(`../phpAPIs/CR avaliacao/getAvaliacao.php?id_agendamento=${id_agendamento}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.sucesso) {
                                btn.disabled = true;
                                btn.style.backgroundColor = "#A0A0A0";
                                btn.textContent = "Avaliado";
                                //pra mostrar a nota que foi enviada
                                select.value = data.nota;
                            }
                        })
                        .catch(err => console.error("Erro ao verificar avaliação:", err));
                });
            }

            document.addEventListener("DOMContentLoaded", function () {

                const navBarPerfil = document.getElementById("perfil");
                const navBarAgenda = document.getElementById("agenda");
                const navBarNovoAgendamento = document.getElementById("novoAgendamento");

                fetch("../phpAPIs/getInfoUsuario.php")
                    .then(response => response.json())
                    .then(data => {
                        if (data.tipo_conta == "profissional") {
                            navBarNovoAgendamento.style.display = "none";
                            navBarPerfil.href = "../perfilProfissional/index.html";
                            navBarAgenda.href = "../telaPrincipalProfissional/index.html";
                        } else {
                            navBarNovoAgendamento.style.display = "block";
                            navBarPerfil.href = "../perfilCliente/index.html";
                            navBarAgenda.href = "../telaPrincipalCliente/index.html";
                        }
                        
                        pegarAgendamentos(data.tipo_conta);
                        
                    })
                    .catch(err => {
                        console.error("Erro no fetch:", err);
                    });

            });
        </script>

    </body>
</html>
